<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Austrian Municipalities Guessing Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }
        
        #sidebar {
            width: 300px;
            padding: 20px;
            background-color: #f5f5f5;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        
        #main {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .guess-input {
            font-size: 16px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        
        .button {
            margin-top: 10px;
            width: 100%;
            font-size: 16px;
            padding: 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .button:hover {
            background-color: #45a049;
        }
        
        .reset-button {
            background-color: #f44336;
        }
        
        .reset-button:hover {
            background-color: #d32f2f;
        }
        
        .guessed-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            background-color: white;
        }
        
        hr {
            border: 0;
            height: 1px;
            background-color: #ddd;
            margin: 15px 0;
        }
        
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 4px;
            text-align: center;
            line-height: 20px;
            color: white;
        }
        
        municipality {
            fill: lightgray;
            stroke: white;
            stroke-width: 0.5px;
        }
        
        municipality.guessed {
            fill: forestgreen;
        }
        
        municipality:hover {
            stroke-width: 1px;
            stroke: #333;
        }
        
        #tooltip {
            position: absolute;
            display: none;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>Austrian Municipalities Guessing Game</h2>
        
        <input type="text" id="guessInput" class="guess-input" placeholder="e.g., Weyer">
        <button id="submitGuess" class="button">Submit Guess</button>
        
        <hr>
        
        <h3>Your Progress</h3>
        <div class="progress-container">
            <div id="progressBar" class="progress-bar" style="width: 0%;">0%</div>
        </div>
        <p>Population covered: <span id="populationCovered">0</span> out of <span id="totalPopulation">0</span></p>
        
        <hr>
        
        <h3>Correctly Guessed Municipalities</h3>
        <div id="guessedList" class="guessed-list">
            <p>None yet. Start guessing!</p>
        </div>
        
        <hr>
        
        <button id="resetGame" class="button reset-button">Reset Game</button>
        
        <hr>
        
        <p><small>Try to guess as many Austrian municipalities as possible. Each correct guess will fill in the corresponding area on the map. Vienna is special - it's always Wien-Bezirkname.</small></p>
    </div>
    
    <div id="main">
        <div id="map"></div>
        <div id="tooltip"></div>
    </div>

    <script>
        // Main variables
        let geojsonData;
        let populationData;
        let totalPopulation = 0;
        let coveredPopulation = 0;
        let guessedMunicipalities = [];
        
        // SVG and projection setup
        const width = document.getElementById('main').offsetWidth;
        const height = document.getElementById('main').offsetHeight;
        let svg, g, path, tooltip;
        
        // Initialize the map
        async function initMap() {
            // Create SVG
            svg = d3.select("#map")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [0, 0, width, height]);
            
            // Create group for the map
            g = svg.append("g");
            
            // Create tooltip
            tooltip = d3.select("#tooltip");
            
            try {
                // Load GeoJSON data
                const response = await fetch('STATISTIK_AUSTRIA_GEM_20250101.geo.json');
                geojsonData = await response.json();
                
                // Load population data
                const popResponse = await fetch('bevölkerungsstand.csv');
                const populationCsv = await popResponse.text();
                
                // Parse CSV
                Papa.parse(populationCsv, {
                    header: true,
                    delimiter: ";",
                    dynamicTyping: true,
                    complete: function(results) {
                        populationData = results.data;
                        
                        // Data corrections as in the original code
                        const lenzingIndex = populationData.findIndex(d => d.Name === "Lenzing");
                        if (lenzingIndex !== -1) {
                            populationData[lenzingIndex].Name = "Lenzing an der Ager";
                        }
                        
                        const sochauIndex = populationData.findIndex(d => d.Name === "Söchau");
                        if (sochauIndex !== -1) {
                            populationData.splice(sochauIndex, 1);
                        }
                        
                        const furstenfeldIndex = populationData.findIndex(d => d.Name === "Fürstenfeld");
                        if (furstenfeldIndex !== -1) {
                            populationData[furstenfeldIndex].ID = "62280";
                        }
                        
                        // Calculate total population
                        totalPopulation = populationData.reduce((sum, item) => sum + (item.Wert || 0), 0);
                        document.getElementById('totalPopulation').textContent = totalPopulation.toLocaleString();
                        
                        // Join geojson with population data
                        geojsonData.features.forEach(feature => {
                            const popData = populationData.find(p => p.ID === feature.properties.g_id);
                            if (popData) {
                                feature.properties.Name = popData.Name;
                                feature.properties.population = popData.Wert;
                            }
                            feature.properties.guessed = false;
                        });
                        
                        // Draw the map
                        drawMap();
                        
                        // Set up event listeners
                        setupEventListeners();
                    }
                });
            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('map').innerHTML = "Error loading data. Please check console for details.";
            }
        }
        
        // Draw the map
        function drawMap() {
            // Define projection
            const projection = d3.geoMercator()
                .fitSize([width, height], geojsonData);
            
            // Define path generator
            path = d3.geoPath().projection(projection);
            
            // Draw municipalities
            g.selectAll("path")
                .data(geojsonData.features)
                .enter()
                .append("path")
                .attr("class", "municipality")
                .attr("d", path)
                .attr("id", d => `municipality-${d.properties.g_id}`)
                .on("mouseover", function(event, d) {
                    // Show tooltip
                    tooltip.style("display", "block")
                        .html(`<strong>${d.properties.Name || 'Unknown'}</strong><br>` +
                              `Population: ${d.properties.population ? d.properties.population.toLocaleString() : 'N/A'}`);
                    
                    d3.select(this).style("stroke-width", "2px");
                })
                .on("mousemove", function(event) {
                    tooltip.style("left", (event.pageX + 15) + "px")
                           .style("top", (event.pageY - 20) + "px");
                })
                .on("mouseout", function() {
                    // Hide tooltip
                    tooltip.style("display", "none");
                    d3.select(this).style("stroke-width", "0.5px");
                });
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Submit guess
            document.getElementById('submitGuess').addEventListener('click', handleGuess);
            document.getElementById('guessInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleGuess();
                }
            });
            
            // Reset game
            document.getElementById('resetGame').addEventListener('click', resetGame);
        }
        
        // Handle a guess
        function handleGuess() {
            const guessInput = document.getElementById('guessInput');
            const guess = guessInput.value.trim().toLowerCase();
            
            if (guess) {
                // Find matching municipality
                const matchingFeature = geojsonData.features.find(
                    feature => feature.properties.Name && 
                    feature.properties.Name.toLowerCase() === guess &&
                    !feature.properties.guessed
                );
                
                if (matchingFeature) {
                    // Mark as guessed
                    matchingFeature.properties.guessed = true;
                    guessedMunicipalities.push({
                        name: matchingFeature.properties.Name,
                        population: matchingFeature.properties.population || 0
                    });
                    
                    // Update visualization
                    d3.select(`#municipality-${matchingFeature.properties.g_id}`)
                        .classed("guessed", true);
                    
                    // Update population count
                    if (matchingFeature.properties.population) {
                        coveredPopulation += matchingFeature.properties.population;
                        updateProgress();
                    }
                    
                    // Update guessed list
                    updateGuessedList();
                }
                
                // Clear input
                guessInput.value = "";
                guessInput.focus();
            }
        }
        
        // Update progress bar and counters
        function updateProgress() {
            const percentage = (coveredPopulation / totalPopulation) * 100;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressBar').textContent = `${percentage.toFixed(1)}%`;
            document.getElementById('populationCovered').textContent = coveredPopulation.toLocaleString();
        }
        
        // Update guessed municipalities list
        function updateGuessedList() {
            const listContainer = document.getElementById('guessedList');
            
            // Sort by population
            guessedMunicipalities.sort((a, b) => b.population - a.population);
            
            // Update list
            if (guessedMunicipalities.length > 0) {
                let html = '';
                guessedMunicipalities.forEach(item => {
                    html += `<div><strong>${item.name}</strong> (${item.population.toLocaleString()})</div>`;
                });
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = '<p>None yet. Start guessing!</p>';
            }
        }
        
        // Reset the game
        function resetGame() {
            // Reset variables
            coveredPopulation = 0;
            guessedMunicipalities = [];
            
            // Reset map
            geojsonData.features.forEach(feature => {
                feature.properties.guessed = false;
            });
            
            // Update visualization
            d3.selectAll(".municipality").classed("guessed", false);
            
            // Update UI
            updateProgress();
            updateGuessedList();
            
            // Clear input
            document.getElementById('guessInput').value = "";
            document.getElementById('guessInput').focus();
        }
        
        // Initialize the application
        window.onload = initMap;
    </script>
</body>
</html>